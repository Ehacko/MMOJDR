<!DOCTYPE html>

<html lang="en">

<head>

<meta charset="UTF-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Document</title>

<style>

* {

image-rendering: pixelated;

box-sizing: border-box;

}

body { margin: 0; padding: 0; }

</style>

</head>

<body>

<canvas id="ctx" width="500" height="500" style="border: 1px solid black;"></canvas>


<script src="//cdn.jsdelivr.net/npm/eruda"></script>

<script src="./client/js/socket.io.js"></script>

<script>

//mobile debugger

const cl = console.log

const el = document.createElement('div'); 

eruda.init();

document.body.appendChild(el); 

eruda.init({ container: el, tool: ['console', 'elements'] });


//canvas data

const ctx = document.getElementById('ctx').getContext("2d")

ctx.height = document.getElementById('ctx').offsetHeight-2

ctx.width = document.getElementById('ctx').offsetWidth -2

ctx.font = '16px Arial'


//sprites data

const sprite_size = 50

const player_size = 100

const assets = {}

assets.player = new Image(); assets.player.src = '/client/img/Demo_sprite.webp'

assets.shadow = new Image(); assets.shadow.src = '/client/img/Shadow_sprite.webp'

assets.entity = new Image(); assets.entity.src = '/client/img/Demo_sprite.webp'

assets.map = new Image(); assets.map.src = '/client/img/Demo_map.webp'


//socket actions

const socket = io() 

var player_id = null

socket.on('init', (data) => { player_id = data.id })

//frame data

socket.on('newPositions', (data) => {

if (!player_id) return;

renderFrame(data) }

)

function renderFrame(data){

//reset canvas

ctx.clearRect(0,0,500,500)

//anti-aliasing

ctx.imageSmoothingEnabled = false;

//define player

const player = data.find(x => x.color == 'red')

//map render from player POV

ctx.drawImage(assets.map,

0,0,assets.map.width,assets.map.height,

ctx.width/2-player.x,ctx.width/2-player.y,

800,800)

//render player at the center of the screen

ctx.drawImage(assets.player, 

0, 0, assets.player.width/4, assets.player.height/4,

ctx.width/2-player_size/2,ctx.height/2-player_size/2,

player_size,player_size 

)

//render the other players

for(var i = 0; i < data.length; i++){

if (data[i].color == 'red') continue

[x, y, number, color] = [data[i].x, data[i].y, number = data[i].number, data[i].color]

ctx.fillStyle = color ; 

ctx.fillRect( ctx.width/2-player.x+x-sprite_size/2, ctx.height/2-player.y+y-sprite_size/2, sprite_size, sprite_size )

ctx.fillStyle = "black"; 

}

}


//keyboard interaction

const keys = { 38: "up", 37: "left", 39: "right", 40: "down" }

document.addEventListener('keydown', event =>{

socket.emit('keypress', {inputId: keys[event.which], state: true})

})

document.addEventListener('keyup', event =>{

socket.emit('keypress', {inputId: keys[event.which], state: false})

})


</script>

</body>

</html>

